import { router } from '@kit.ArkUI';

// å†å²æ•°æ®æ¨¡å‹
interface HistoryDataPoint {
  timestamp: number; // æ—¶é—´æˆ³
  soilMoisture: number; // åœŸå£¤æ¹¿åº¦
  temperature: number; // æ¸©åº¦
  humidity: number; // æ¹¿åº¦
  lightIntensity: number; // å…‰ç…§å¼ºåº¦
}

// å›¾è¡¨æ•°æ®ç‚¹
interface ChartPoint {
  x: number; // xåæ ‡
  y: number; // yåæ ‡
  value: number; // åŸå§‹å€¼
  time: string; // æ—¶é—´æ ‡ç­¾
}

@Entry
@Component
export default struct HistoryDataPage {
  @State selectedTab: number = 0; // å½“å‰é€‰ä¸­çš„æ•°æ®ç±»å‹
  @State timeRange: string = 'week'; // æ—¶é—´èŒƒå›´ï¼šday/week
  @State historyData: HistoryDataPoint[] = [];
  @State chartData: ChartPoint[] = [];
  @State isLoading: boolean = false;

  // æ•°æ®ç±»å‹é€‰é¡¹
  private dataTypes: string[] = ['åœŸå£¤æ¹¿åº¦', 'ç¯å¢ƒæ¸©åº¦', 'ç¯å¢ƒæ¹¿åº¦', 'å…‰ç…§å¼ºåº¦'];
  private dataKeys: string[] = ['soilMoisture', 'temperature', 'humidity', 'lightIntensity'];

  aboutToAppear() {
    this.loadHistoryData();
  }

  // ã€æ•°æ®è¯·æ±‚ç‚¹ã€‘åŠ è½½å†å²æ•°æ®
  async loadHistoryData() {
    this.isLoading = true;
    
    try {
      // ã€æ•°æ®è¯·æ±‚ç‚¹ã€‘æ­¤å¤„åº”è¿æ¥å†å²æ•°æ®API
      // è¯·æ±‚å‚æ•°ï¼š{
      //   timeRange: this.timeRange, // 'day' | 'week'
      //   startTime: èµ·å§‹æ—¶é—´æˆ³,
      //   endTime: ç»“æŸæ—¶é—´æˆ³,
      //   dataType: 'all' // è·å–æ‰€æœ‰ç±»å‹æ•°æ®
      // }
      // é¢„æœŸè¿”å›æ ¼å¼ï¼š{
      //   success: boolean,
      //   data: HistoryDataPoint[] // æŒ‰æ—¶é—´æ’åºçš„å†å²æ•°æ®æ•°ç»„
      // }
      
      // æ¨¡æ‹Ÿæ•°æ® - å®é™…åº”æ›¿æ¢ä¸ºAPIè°ƒç”¨
      const mockData = this.generateMockHistoryData();
      this.historyData = mockData;
      this.updateChartData();
      
    } catch (error) {
      console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // ç”Ÿæˆæ¨¡æ‹Ÿå†å²æ•°æ®
  private generateMockHistoryData(): HistoryDataPoint[] {
    const data: HistoryDataPoint[] = [];
    const now = Date.now();
    const interval = this.timeRange === 'day' ? 60 * 60 * 1000 : 24 * 60 * 60 * 1000; // å°æ—¶æˆ–å¤©
    const count = this.timeRange === 'day' ? 24 : 7;

    for (let i = count - 1; i >= 0; i--) {
      data.push({
        timestamp: now - i * interval,
        soilMoisture: 45 + Math.random() * 20,
        temperature: 22 + Math.random() * 8,
        humidity: 60 + Math.random() * 20,
        lightIntensity: 300 + Math.random() * 200
      });
    }
    return data;
  }

  // æ›´æ–°å›¾è¡¨æ•°æ®
  private updateChartData() {
    if (this.historyData.length === 0) return;

    const dataKey = this.dataKeys[this.selectedTab] as keyof HistoryDataPoint;
    const chartWidth = 280; // è®¾å®šå›ºå®šå®½åº¦ä¸Canvaså¯¹åº”
    const chartHeight = 180;
    const padding = 20;

    // è®¡ç®—æ•°å€¼èŒƒå›´
    const values = this.historyData.map(item => {
      switch (dataKey) {
        case 'soilMoisture':
          return item.soilMoisture;
        case 'temperature':
          return item.temperature;
        case 'humidity':
          return item.humidity;
        case 'lightIntensity':
          return item.lightIntensity;
        default:
          return 0;
      }
    });
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const valueRange = maxValue - minValue || 1;

    // æ·»åŠ ä¸€äº›è¾¹è·ä»¥é¿å…ç‚¹è´´è¾¹
    const displayMin = minValue - valueRange * 0.1;
    const displayMax = maxValue + valueRange * 0.1;
    const displayRange = displayMax - displayMin;

    this.chartData = this.historyData.map((item, index) => {
      let value: number;
      switch (dataKey) {
        case 'soilMoisture':
          value = item.soilMoisture;
          break;
        case 'temperature':
          value = item.temperature;
          break;
        case 'humidity':
          value = item.humidity;
          break;
        case 'lightIntensity':
          value = item.lightIntensity;
          break;
        default:
          value = 0;
      }

      // è®¡ç®—xä½ç½®ï¼ˆæ·»åŠ å·¦è¾¹è·ï¼‰
      const x = padding + (index / Math.max(this.historyData.length - 1, 1)) * (chartWidth - 2 * padding);
      // è®¡ç®—yä½ç½®ï¼ˆæ·»åŠ ä¸Šä¸‹è¾¹è·ï¼Œyè½´ä»ä¸Šåˆ°ä¸‹ï¼‰
      const normalizedValue = (value - displayMin) / displayRange;
      const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));

      const chartPoint: ChartPoint = {
        x,
        y,
        value,
        time: this.formatTime(item.timestamp)
      };
      return chartPoint;
    });

  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    if (this.timeRange === 'day') {
      return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    } else {
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
  }

  // åˆ‡æ¢æ•°æ®ç±»å‹
  private switchDataType(index: number) {
    this.selectedTab = index;
    this.updateChartData();
  }

  // åˆ‡æ¢æ—¶é—´èŒƒå›´
  private switchTimeRange(range: string) {
    if (this.timeRange !== range) {
      this.timeRange = range;
      this.loadHistoryData();
    }
  }

  // å¯¼å‡ºæ•°æ®åŠŸèƒ½
  private exportData() {
    // ã€æ•°æ®è¯·æ±‚ç‚¹ã€‘å¯¼å‡ºå†å²æ•°æ®
    // æ­¤å¤„åº”è°ƒç”¨å¯¼å‡ºAPIï¼Œå°†å½“å‰æŸ¥è¯¢çš„å†å²æ•°æ®å¯¼å‡ºä¸ºExcelæˆ–CSVæ ¼å¼
    // å¯¼å‡ºå‚æ•°ï¼š{
    //   data: this.historyData,
    //   format: 'excel' | 'csv',
    //   filename: `å†œç”°æ•°æ®_${this.timeRange}_${new Date().toISOString()}`
    // }
    console.log('å¯¼å‡ºæ•°æ®åŠŸèƒ½å¾…å®ç°');
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .onClick(() => router.back())
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .borderRadius(20)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .fontSize(14)
          .margin({ right: 16 })

        Text('å†å²æ•°æ®åˆ†æ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)

        Button('ğŸ“Š å¯¼å‡º')
          .onClick(() => this.exportData())
          .backgroundColor('#2196F3')
          .fontColor(Color.White)
          .borderRadius(20)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .fontSize(14)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 8, color: '#00000010', offsetY: 2 })

      Scroll() {

        Column() {
          // æ—¶é—´èŒƒå›´é€‰æ‹©
          Row() {
            Text('ğŸ“… æ—¶é—´èŒƒå›´')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .margin({ right: 16 })

            Button('ğŸ“† æŒ‰æ—¥')
              .onClick(() => this.switchTimeRange('day'))
              .backgroundColor(this.timeRange === 'day' ? '#4CAF50' : '#F5F5F5')
              .fontColor(this.timeRange === 'day' ? Color.White : '#666666')
              .borderRadius(18)
              .padding({ left: 20, right: 20, top: 8, bottom: 8 })
              .fontSize(14)
              .margin({ right: 12 })
              .shadow(this.timeRange === 'day' ?
                { radius: 8, color: '#4CAF5030', offsetY: 2 } :
                { radius: 0, color: Color.Transparent, offsetY: 0 })

            Button('ğŸ“Š æŒ‰å‘¨')
              .onClick(() => this.switchTimeRange('week'))
              .backgroundColor(this.timeRange === 'week' ? '#4CAF50' : '#F5F5F5')
              .fontColor(this.timeRange === 'week' ? Color.White : '#666666')
              .borderRadius(18)
              .padding({ left: 20, right: 20, top: 8, bottom: 8 })
              .fontSize(14)
              .shadow(this.timeRange === 'week' ?
                { radius: 8, color: '#4CAF5030', offsetY: 2 } :
                { radius: 0, color: Color.Transparent, offsetY: 0 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })
          .shadow({ radius: 4, color: '#00000008', offsetY: 1 })

          // æ•°æ®ç±»å‹é€‰æ‹©æ ‡ç­¾
          Row() {
            ForEach(this.dataTypes, (type: string, index: number) => {
              Button(type)
                .onClick(() => this.switchDataType(index))
                .backgroundColor(this.selectedTab === index ? '#4CAF50' : '#F5F5F5')
                .fontColor(this.selectedTab === index ? Color.White : '#666666')
                .borderRadius(16)
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .fontSize(13)
                .margin({ right: 8 })
                .shadow(this.selectedTab === index ?
                  { radius: 6, color: '#4CAF5028', offsetY: 2 } :
                  { radius: 0, color: Color.Transparent, offsetY: 0 })
            })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 12 })
          .shadow({ radius: 4, color: '#00000008', offsetY: 1 })

          // å›¾è¡¨åŒºåŸŸ
          Column() {
            Text(`ğŸ“ˆ ${this.dataTypes[this.selectedTab]}è¶‹åŠ¿å›¾`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })

            if (this.isLoading) {
              LoadingProgress()
                .width(50)
                .height(50)
                .margin(32)
                .color('#4CAF50')
            } else {
              // æ”¹è¿›çš„æŠ˜çº¿å›¾å®ç°
              Stack() {
                // èƒŒæ™¯ç½‘æ ¼
                Column() {
                  ForEach([0, 1, 2, 3, 4], (item: number) => {
                    Divider()
                      .strokeWidth(1)
                      .color('#E8E8E8')
                      .margin({ top: item === 0 ? 0 : 40 })
                  })
                }
                .width('90%')
                .height(200)
                .alignItems(HorizontalAlign.Start)

                // Canvaså›¾è¡¨
                if (this.chartData.length > 0) {
                  Stack() {
                    Canvas(this.drawChart.bind(this))
                      .width('90%')
                      .height(200)
                      .backgroundColor(Color.Transparent)
                      .onReady(() => {
                        // Canvaså‡†å¤‡å°±ç»ªï¼Œè§¦å‘ç»˜åˆ¶
                        console.log('Canvas ready')
                      })
                  }
                  .width('100%')
                  .height(200)
                }
              }
              .width('100%')
              .height(220)
              .padding(16)
              .backgroundColor('#FAFAFA')
              .borderRadius(12)
              .border({ width: 1, color: '#E8E8E8' })

              // æ•°æ®ç»Ÿè®¡ä¿¡æ¯
              Column() {
                Text('ğŸ“Š ç»Ÿè®¡ä¿¡æ¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 16 })

                if (this.chartData.length > 0) {
                  Row() {
                    Column() {
                      Text('ğŸ“ˆ æœ€å¤§å€¼')
                        .fontSize(12)
                        .fontColor('#999')
                        .margin({ bottom: 4 })
                      Text(`${Math.max(...this.chartData.map(p => p.value)).toFixed(1)}`)
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#4CAF50')
                    }
                    .width('33%')
                    .padding(12)
                    .backgroundColor('#F0F9F0')
                    .borderRadius(12)
                    .alignItems(HorizontalAlign.Center)

                    Column() {
                      Text('ğŸ“‰ æœ€å°å€¼')
                        .fontSize(12)
                        .fontColor('#999')
                        .margin({ bottom: 4 })
                      Text(`${Math.min(...this.chartData.map(p => p.value)).toFixed(1)}`)
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#FF5722')
                    }
                    .width('33%')
                    .padding(12)
                    .backgroundColor('#FFF3F0')
                    .borderRadius(12)
                    .alignItems(HorizontalAlign.Center)
                    .margin({ left: 8, right: 8 })

                    Column() {
                      Text('â— å¹³å‡å€¼')
                        .fontSize(12)
                        .fontColor('#999')
                        .margin({ bottom: 4 })
                      Text(`${(this.chartData.reduce((sum, p) => sum + p.value, 0) / this.chartData.length).toFixed(1)}`)
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#2196F3')
                    }
                    .width('33%')
                    .padding(12)
                    .backgroundColor('#F0F7FF')
                    .borderRadius(12)
                    .alignItems(HorizontalAlign.Center)
                  }
                  .justifyContent(FlexAlign.SpaceBetween)
                  .width('100%')
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ top: 16 })
              .shadow({ radius: 4, color: '#00000008', offsetY: 1 })
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin(16)
          .shadow({ radius: 8, color: '#00000010', offsetY: 2 })

          // è¯¦ç»†æ•°æ®åˆ—è¡¨
          Column() {
            Text('ğŸ“‹ è¯¦ç»†æ•°æ®è®°å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 16 })

            List({ space: 12 }) {
              ForEach(this.historyData.slice().reverse(), (item: HistoryDataPoint, index: number) => {
                ListItem() {
                  Row() {
                    Column() {
                      Text(this.formatTime(item.timestamp))
                        .fontSize(14)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#333')
                      Text(new Date(item.timestamp).toLocaleDateString())
                        .fontSize(11)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .width('25%')

                    Column() {
                      Text(`${item.soilMoisture.toFixed(1)}%`)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#4CAF50')
                      Text('åœŸå£¤æ¹¿åº¦')
                        .fontSize(11)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                    .width('18%')

                    Column() {
                      Text(`${item.temperature.toFixed(1)}Â°C`)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#FF9800')
                      Text('æ¸©åº¦')
                        .fontSize(11)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                    .width('18%')

                    Column() {
                      Text(`${item.humidity.toFixed(1)}%`)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#2196F3')
                      Text('æ¹¿åº¦')
                        .fontSize(11)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                    .width('18%')

                    Column() {
                      Text(`${item.lightIntensity.toFixed(0)}`)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#FFC107')
                      Text('å…‰ç…§')
                        .fontSize(11)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                    .width('21%')
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor(Color.White)
                  .borderRadius(12)
                  .shadow({ radius: 4, color: '#00000006', offsetY: 1 })
                }
              })
            }
            .width('100%')
            .height(300)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#F9F9F9')
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 16 })
          .shadow({ radius: 8, color: '#00000010', offsetY: 2 })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
  }

  // ç»˜åˆ¶æŠ˜çº¿å›¾
  private drawChart(context: CanvasRenderingContext2D) {
    if (this.chartData.length === 0) return;

    const chartWidth = 280;
    const chartHeight = 180;

    // æ¸…ç©ºç”»å¸ƒ
    context.clearRect(0, 0, chartWidth, chartHeight);

    // ç»˜åˆ¶æ¸å˜èƒŒæ™¯åŒºåŸŸ
    context.save();
    context.beginPath();
    context.moveTo(this.chartData[0].x, chartHeight - 20);

    // ç»˜åˆ¶åˆ°æ¯ä¸ªæ•°æ®ç‚¹
    this.chartData.forEach(point => {
      context.lineTo(point.x, point.y);
    });

    // å®Œæˆåº•éƒ¨åŒºåŸŸ
    context.lineTo(this.chartData[this.chartData.length - 1].x, chartHeight - 20);
    context.closePath();

    // åˆ›å»ºæ¸å˜
    const gradient = context.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');
    gradient.addColorStop(1, 'rgba(76, 175, 80, 0.05)');
    context.fillStyle = gradient;
    context.fill();
    context.restore();

    // ç»˜åˆ¶ä¸»æŠ˜çº¿
    context.save();
    context.beginPath();
    context.strokeStyle = '#4CAF50';
    context.lineWidth = 3;
    context.lineJoin = 'round';
    context.lineCap = 'round';

    this.chartData.forEach((point, index) => {
      if (index === 0) {
        context.moveTo(point.x, point.y);
      } else {
        context.lineTo(point.x, point.y);
      }
    });

    context.stroke();
    context.restore();

    // ç»˜åˆ¶æ•°æ®ç‚¹
    this.chartData.forEach(point => {
      // å¤–åœˆï¼ˆç™½è‰²è¾¹æ¡†ï¼‰
      context.save();
      context.beginPath();
      context.arc(point.x, point.y, 6, 0, 2 * Math.PI);
      context.fillStyle = '#FFFFFF';
      context.fill();
      context.restore();

      // å†…åœˆï¼ˆç»¿è‰²ï¼‰
      context.save();
      context.beginPath();
      context.arc(point.x, point.y, 4, 0, 2 * Math.PI);
      context.fillStyle = '#4CAF50';
      context.fill();
      context.restore();
    });

    // ç»˜åˆ¶æ—¶é—´æ ‡ç­¾ï¼ˆä»…æ˜¾ç¤ºé¦–å°¾ï¼‰
    context.save();
    context.fillStyle = '#999';
    context.font = '10px sans-serif';

    // ç¬¬ä¸€ä¸ªæ ‡ç­¾
    if (this.chartData.length > 0) {
      const firstPoint = this.chartData[0];
      context.fillText(firstPoint.time, firstPoint.x - 15, chartHeight - 5);

      // æœ€åä¸€ä¸ªæ ‡ç­¾
      const lastPoint = this.chartData[this.chartData.length - 1];
      context.fillText(lastPoint.time, lastPoint.x - 15, chartHeight - 5);
    }

    context.restore();
  }
}