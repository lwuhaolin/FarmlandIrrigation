// ä½œç‰©æ•°æ®ç±»å‹å®šä¹‰
interface Crop {
  id: string;
  name: string;
  variety: string;
  plantingDate: string;
  expectedHarvestDate: string;
  currentStage: string;
  progress: number;
  area: number;
  status: 'healthy' | 'attention' | 'critical';
  location: string;
  lastUpdated: string;
}

// ä½œç‰©é˜¶æ®µå®šä¹‰
interface CropStage {
  name: string;
  duration: number;
  description: string;
  requirements: string[];
  icon: string;
}

// ç§æ¤è®¡åˆ’æ•°æ®
interface PlantingPlan {
  id: string;
  cropName: string;
  variety: string;
  area: number;
  plannedDate: string;
  expectedHarvest: string;
  notes: string;
}


interface CropType {
  name: string;
  varieties: string[];
  stages: CropStage[];
  totalDays: number;
}
@Component
export default struct CropStageManagePage {
  @State currentTab: number = 0;
  @State crops: Crop[] = [];
  @State plantingPlans: PlantingPlan[] = [];
  @State selectedCrop: Crop | null = null;
  @State showAddDialog: boolean = false;
  @State showPlanDialog: boolean = false;
  @State searchText: string = '';
  @State filterStatus: string = 'all';
  @State isLoading: boolean = false;
  @State lastRefresh: string = '';

  // æ–°å»ºè®¡åˆ’è¡¨å•æ•°æ®
  @State newPlanCropName: string = '';
  @State newPlanVariety: string = '';
  @State newPlanArea: string = '';
  @State newPlanDate: string = '';
  @State newPlanNotes: string = '';

  // ä½œç‰©ç±»å‹é…ç½®
  private readonly cropTypes: CropType[]  = [
    {
      name: 'æ°´ç¨»',
      varieties: ['ä¼˜è´¨ç¨»', 'è¶…çº§ç¨»', 'é¦™ç±³', 'ç³¯ç±³'],
      stages: [
        { name: 'æ’­ç§', duration: 7, description: 'ç§å­èŒå‘æœŸ', requirements: ['é€‰ç§', 'æµ¸ç§', 'å‚¬èŠ½'], icon: 'ğŸŒ±' },
        { name: 'å‘èŠ½', duration: 10, description: 'å¹¼è‹—å‡ºåœŸæœŸ', requirements: ['ä¿æ¹¿', 'æ¸©æ§', 'å…‰ç…§'], icon: 'ğŸŒ¿' },
        { name: 'åˆ†è˜–', duration: 25, description: 'è¥å…»ç”Ÿé•¿æœŸ', requirements: ['æ–½è‚¥', 'çŒæ°´', 'é™¤è‰'], icon: 'ğŸŒ¾' },
        { name: 'æ‹”èŠ‚', duration: 20, description: 'èŒç§†ä¼¸é•¿æœŸ', requirements: ['è¿½è‚¥', 'æ§æ°´', 'é˜²è™«'], icon: 'ğŸ‹' },
        { name: 'æŠ½ç©—', duration: 15, description: 'ç”Ÿæ®–ç”Ÿé•¿æœŸ', requirements: ['å……è¶³æ°´åˆ†', 'é˜²ç—…'], icon: 'ğŸŒ¾' },
        { name: 'çŒæµ†', duration: 30, description: 'ç±½ç²’å……å®æœŸ', requirements: ['é€‚åº¦å¹²æ¹¿', 'é˜²å€’ä¼'], icon: 'ğŸŒ¾' },
        { name: 'æˆç†Ÿ', duration: 15, description: 'æ”¶è·æœŸ', requirements: ['é€‚æ—¶æ”¶å‰²'], icon: 'ğŸŒ¾' }
      ],
      totalDays: 122
    },
    {
      name: 'ç‰ç±³',
      varieties: ['ç”œç‰ç±³', 'ç³¯ç‰ç±³', 'é¥²æ–™ç‰ç±³', 'çˆ†è£‚ç‰ç±³'],
      stages: [
        { name: 'æ’­ç§', duration: 5, description: 'ç§å­æ’­ç§æœŸ', requirements: ['æ•´åœ°', 'æ–½åº•è‚¥'], icon: 'ğŸŒ±' },
        { name: 'å‡ºè‹—', duration: 8, description: 'å¹¼è‹—æœŸ', requirements: ['ä¿å¢’', 'é—´è‹—'], icon: 'ğŸŒ¿' },
        { name: 'æ‹”èŠ‚', duration: 30, description: 'è¥å…»ç”Ÿé•¿æœŸ', requirements: ['è¿½è‚¥', 'åŸ¹åœŸ'], icon: 'ğŸŒ½' },
        { name: 'æŠ½é›„', duration: 10, description: 'é›„ç©—æœŸ', requirements: ['å……è¶³æ°´åˆ†'], icon: 'ğŸŒ½' },
        { name: 'åä¸', duration: 5, description: 'é›Œç©—æœŸ', requirements: ['æˆç²‰ä¿æŠ¤'], icon: 'ğŸŒ½' },
        { name: 'çŒæµ†', duration: 35, description: 'ç±½ç²’å½¢æˆæœŸ', requirements: ['é˜²è™«å®³'], icon: 'ğŸŒ½' },
        { name: 'æˆç†Ÿ', duration: 12, description: 'æ”¶è·æœŸ', requirements: ['é€‚æ—¶æ”¶è·'], icon: 'ğŸŒ½' }
      ],
      totalDays: 105
    },
    {
      name: 'å°éº¦',
      varieties: ['æ˜¥å°éº¦', 'å†¬å°éº¦', 'ç¡¬è´¨éº¦', 'è½¯è´¨éº¦'],
      stages: [
        { name: 'æ’­ç§', duration: 7, description: 'æ’­ç§æœŸ', requirements: ['æ•´åœ°', 'é€‰ç§'], icon: 'ğŸŒ±' },
        { name: 'å‡ºè‹—', duration: 10, description: 'å‡ºè‹—æœŸ', requirements: ['ä¿å¢’', 'é™¤è‰'], icon: 'ğŸŒ¿' },
        { name: 'åˆ†è˜–', duration: 35, description: 'åˆ†è˜–æœŸ', requirements: ['è¿½è‚¥', 'çŒæ°´'], icon: 'ğŸŒ¾' },
        { name: 'æ‹”èŠ‚', duration: 25, description: 'æ‹”èŠ‚æœŸ', requirements: ['é˜²å€’ä¼'], icon: 'ğŸŒ¾' },
        { name: 'æŠ½ç©—', duration: 12, description: 'æŠ½ç©—æœŸ', requirements: ['é˜²ç—…è™«'], icon: 'ğŸŒ¾' },
        { name: 'å¼€èŠ±', duration: 8, description: 'å¼€èŠ±æœŸ', requirements: ['é€‚å®œæ¸©åº¦'], icon: 'ğŸŒ¾' },
        { name: 'çŒæµ†', duration: 25, description: 'çŒæµ†æœŸ', requirements: ['å……è¶³æ°´åˆ†'], icon: 'ğŸŒ¾' },
        { name: 'æˆç†Ÿ', duration: 15, description: 'æˆç†ŸæœŸ', requirements: ['é€‚æ—¶æ”¶å‰²'], icon: 'ğŸŒ¾' }
      ],
      totalDays: 137
    }
  ];

  aboutToAppear() {
    this.initializeData();
    this.loadCropData();
  }

  private initializeData(): void {
    this.lastRefresh = new Date().toLocaleString();
    this.generateMockData();
  }

  private generateMockData(): void {
    this.crops = [
      {
        id: '1',
        name: 'æ°´ç¨»',
        variety: 'ä¼˜è´¨ç¨»',
        plantingDate: '2024-03-15',
        expectedHarvestDate: '2024-07-15',
        currentStage: 'åˆ†è˜–',
        progress: 45,
        area: 10.5,
        status: 'healthy',
        location: 'ä¸œåŒºç”°å—A1',
        lastUpdated: '2024-03-28 14:30'
      },
      {
        id: '2',
        name: 'ç‰ç±³',
        variety: 'ç”œç‰ç±³',
        plantingDate: '2024-04-01',
        expectedHarvestDate: '2024-07-20',
        currentStage: 'å‡ºè‹—',
        progress: 20,
        area: 8.2,
        status: 'attention',
        location: 'è¥¿åŒºç”°å—B2',
        lastUpdated: '2024-04-05 09:15'
      },
      {
        id: '3',
        name: 'å°éº¦',
        variety: 'å†¬å°éº¦',
        plantingDate: '2024-02-10',
        expectedHarvestDate: '2024-06-25',
        currentStage: 'æ‹”èŠ‚',
        progress: 65,
        area: 15.0,
        status: 'healthy',
        location: 'å—åŒºç”°å—C3',
        lastUpdated: '2024-04-01 16:45'
      }
    ];

    this.plantingPlans = [
      {
        id: 'plan1',
        cropName: 'æ°´ç¨»',
        variety: 'é¦™ç±³',
        area: 12.0,
        plannedDate: '2024-04-20',
        expectedHarvest: '2024-08-20',
        notes: 'è®¡åˆ’åœ¨é›¨å­£å‰å®Œæˆæ’­ç§'
      },
      {
        id: 'plan2',
        cropName: 'ç‰ç±³',
        variety: 'ç³¯ç‰ç±³',
        area: 6.5,
        plannedDate: '2024-05-01',
        expectedHarvest: '2024-08-15',
        notes: 'é€‚åˆåˆ¶ä½œç‰ç±³æ·±åŠ å·¥äº§å“'
      }
    ];
  }

  private async loadCropData(): Promise<void> {
    this.isLoading = true;
    try {
      await new Promise<void>(resolve => setTimeout(resolve, 1000));
      this.lastRefresh = new Date().toLocaleString();
    } catch (error) {
      console.error('åŠ è½½ä½œç‰©æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private getFilteredCrops(): Crop[] {
    return this.crops.filter(crop => {
      const matchesSearch = crop.name.includes(this.searchText) || 
                           crop.variety.includes(this.searchText) ||
                           crop.location.includes(this.searchText);
      const matchesStatus = this.filterStatus === 'all' || crop.status === this.filterStatus;
      return matchesSearch && matchesStatus;
    });
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'healthy': return '#52C41A';
      case 'attention': return '#FAAD14';
      case 'critical': return '#FF4D4F';
      default: return '#8A8A8A';
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'healthy': return 'å¥åº·';
      case 'attention': return 'éœ€å…³æ³¨';
      case 'critical': return 'å¼‚å¸¸';
      default: return 'æœªçŸ¥';
    }
  }

  // æ‰§è¡Œç§æ¤è®¡åˆ’
  private executePlan(plan: PlantingPlan): void {
    console.log(`æ‰§è¡Œç§æ¤è®¡åˆ’: ${plan.cropName} - ${plan.variety}`);
    // ã€åŠŸèƒ½ç‚¹ã€‘æ‰§è¡Œç§æ¤è®¡åˆ’
    // å°†è®¡åˆ’è½¬æ¢ä¸ºå®é™…çš„ä½œç‰©è®°å½•
    const newCrop: Crop = {
      id: `crop_${Date.now()}`,
      name: plan.cropName,
      variety: plan.variety,
      plantingDate: plan.plannedDate,
      expectedHarvestDate: plan.expectedHarvest,
      currentStage: 'æ’­ç§',
      progress: 0,
      area: plan.area,
      status: 'healthy',
      location: 'å¾…åˆ†é…',
      lastUpdated: new Date().toLocaleString()
    };

    this.crops.push(newCrop);

    // ä»è®¡åˆ’åˆ—è¡¨ä¸­ç§»é™¤
    const index = this.plantingPlans.findIndex(p => p.id === plan.id);
    if (index > -1) {
      this.plantingPlans.splice(index, 1);
    }

    console.log('è®¡åˆ’å·²æ‰§è¡Œï¼Œä½œç‰©å·²æ·»åŠ åˆ°ä½œç‰©åˆ—è¡¨');
  }

  // åˆ é™¤ç§æ¤è®¡åˆ’
  private deletePlan(planId: string): void {
    const index = this.plantingPlans.findIndex(p => p.id === planId);
    if (index > -1) {
      this.plantingPlans.splice(index, 1);
      console.log(`å·²åˆ é™¤ç§æ¤è®¡åˆ’: ${planId}`);
    }
  }

  // æ·»åŠ æ–°çš„ç§æ¤è®¡åˆ’
  private addNewPlan(): void {
    if (!this.newPlanCropName || !this.newPlanVariety || !this.newPlanArea || !this.newPlanDate) {
      console.log('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
      return;
    }

    const area = parseFloat(this.newPlanArea);
    if (isNaN(area) || area <= 0) {
      console.log('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢ç§¯');
      return;
    }

    // è®¡ç®—é¢„æœŸæ”¶è·æ—¥æœŸ
    const expectedHarvest = this.calculateHarvestDate(this.newPlanCropName, this.newPlanDate);

    const newPlan: PlantingPlan = {
      id: `plan_${Date.now()}`,
      cropName: this.newPlanCropName,
      variety: this.newPlanVariety,
      area: area,
      plannedDate: this.newPlanDate,
      expectedHarvest: expectedHarvest,
      notes: this.newPlanNotes
    };

    this.plantingPlans.push(newPlan);
    this.showPlanDialog = false;
    this.resetPlanForm();

    console.log('æ–°å¢ç§æ¤è®¡åˆ’æˆåŠŸ:', newPlan);
  }

  // è®¡ç®—é¢„æœŸæ”¶è·æ—¥æœŸ
  private calculateHarvestDate(cropName: string, plantingDate: string): string {
    const crop = this.cropTypes.find(c => c.name === cropName);
    if (!crop) {
      return '';
    }

    // éªŒè¯æ—¥æœŸæ ¼å¼å¹¶æ£€æŸ¥æœ‰æ•ˆæ€§
    if (!plantingDate || plantingDate.trim() === '') {
      return '';
    }

    const date = new Date(plantingDate);

    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
    if (isNaN(date.getTime())) {
      return '';
    }

    date.setDate(date.getDate() + crop.totalDays);

    return date.toISOString().split('T')[0];
  }

  // é‡ç½®è®¡åˆ’è¡¨å•
  private resetPlanForm(): void {
    this.newPlanCropName = '';
    this.newPlanVariety = '';
    this.newPlanArea = '';
    this.newPlanDate = '';
    this.newPlanNotes = '';
  }

  // è·å–å½“å‰é€‰æ‹©ä½œç‰©çš„å“ç§åˆ—è¡¨
  private getCurrentVarieties(): string[] {
    const crop = this.cropTypes.find(c => c.name === this.newPlanCropName);
    return crop ? crop.varieties : [];
  }

  build() {
    Column() {
      this.HeaderSection()

      if (this.currentTab === 0) {
        this.CropManagementTab()
      } else {
        this.PlantingPlanTab()
      }

      // æ–°å»ºç§æ¤è®¡åˆ’å¯¹è¯æ¡†
      if (this.showPlanDialog) {
        this.PlanDialogOverlay()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }

  @Builder
  HeaderSection() {
    Column() {
      Row() {
        Text('ä½œç‰©ç®¡ç†')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1F2329')
          .layoutWeight(1)

        Button() {
          Row({ space: 6 }) {
            if (this.isLoading) {
              LoadingProgress()
                .width(16)
                .height(16)
                .color('#FFFFFF')
            } else {
              Text('ğŸ”„')
                .fontSize(14)
            }
            Text('åˆ·æ–°')
              .fontSize(14)
              .fontColor('#FFFFFF')
          }
        }
        .backgroundColor('#1890FF')
        .borderRadius(20)
        .height(36)
        .padding({ left: 16, right: 16 })
        .onClick(() => this.loadCropData())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16 })

      Text(`æœ€åæ›´æ–°ï¼š${this.lastRefresh}`)
        .fontSize(12)
        .fontColor('#8A8A8A')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 16, top: 4 })

      Row() {
        this.TabButton('ä½œç‰©ç›‘æ§', 0)
        this.TabButton('ç§æ¤è®¡åˆ’', 1)
      }
      .width('100%')
      .margin({ top: 16 })
      .padding({ left: 16, right: 16 })
    }
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  TabButton(text: string, index: number) {
    Button(text)
      .fontSize(16)
      .fontColor(this.currentTab === index ? '#1890FF' : '#666666')
      .backgroundColor(this.currentTab === index ? '#E6F7FF' : 'transparent')
      .border({ width: this.currentTab === index ? 2 : 0, color: '#1890FF' })
      .borderRadius(8)
      .layoutWeight(1)
      .margin({ left: index > 0 ? 8 : 0 })
      .onClick(() => {
        this.currentTab = index;
      })
  }

  @Builder
  CropManagementTab() {
    Column({ space: 16 }) {
      this.SearchAndFilterSection()
      this.CropStatsSection()
      this.CropListSection()
    }
    .padding({ top: 16 })
    .layoutWeight(1)
  }

  @Builder
  SearchAndFilterSection() {
    Column({ space: 12 }) {
      Row({ space: 12 }) {
        TextInput({ placeholder: 'æœç´¢ä½œç‰©åç§°ã€å“ç§æˆ–ä½ç½®...' })
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchText = value;
          })
          .borderRadius(8)

        Button('ç­›é€‰')
          .backgroundColor('#52C41A')
          .borderRadius(8)
      }

      Row({ space: 8 }) {
        Text('çŠ¶æ€ç­›é€‰ï¼š')
          .fontSize(14)
          .fontColor('#666666')

        this.FilterChip('å…¨éƒ¨', 'all')
        this.FilterChip('å¥åº·', 'healthy')
        this.FilterChip('éœ€å…³æ³¨', 'attention')
        this.FilterChip('å¼‚å¸¸', 'critical')
      }
    }
    .padding({ left: 16, right: 16 })
  }

  @Builder
  FilterChip(text: string, value: string) {
    Button(text)
      .fontSize(12)
      .fontColor(this.filterStatus === value ? '#FFFFFF' : '#666666')
      .backgroundColor(this.filterStatus === value ? '#1890FF' : '#F5F5F5')
      .borderRadius(16)
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .onClick(() => {
        this.filterStatus = value;
      })
  }

  @Builder
  CropStatsSection() {
    Row({ space: 12 }) {
      this.StatsCard('æ€»ä½œç‰©', this.crops.length.toString(), 'ğŸŒ¾', '#1890FF')
      this.StatsCard('å¥åº·çŠ¶æ€', this.crops.filter(c => c.status === 'healthy').length.toString(), 'âœ…', '#52C41A')
      this.StatsCard('éœ€å…³æ³¨', this.crops.filter(c => c.status === 'attention').length.toString(), 'âš ï¸', '#FAAD14')
      this.StatsCard('ç§æ¤é¢ç§¯', `${this.crops.reduce((sum, c) => sum + c.area, 0).toFixed(1)}äº©`, 'ğŸ“', '#722ED1')
    }
    .padding({ left: 16, right: 16 })
  }

  @Builder
  StatsCard(title: string, value: string, icon: string, color: string) {
    Column({ space: 8 }) {
      Text(icon)
        .fontSize(24)

      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .layoutWeight(1)
    .height(100)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  CropListSection() {
    Column() {
      Row() {
        Text('ä½œç‰©åˆ—è¡¨')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F2329')
          .layoutWeight(1)

        Button('+ æ·»åŠ ä½œç‰©')
          .fontSize(14)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(8)
          .onClick(() => {
            this.showAddDialog = true;
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.getFilteredCrops(), (crop: Crop) => {
            this.CropCard(crop)
          })

          if (this.getFilteredCrops().length === 0) {
            this.EmptyState()
          }
        }
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .layoutWeight(1)
    }
    .layoutWeight(1)
  }

  @Builder
  CropCard(crop: Crop) {
    Column({ space: 12 }) {
      Row() {
        Column({ space: 4 }) {
          Row({ space: 8 }) {
            Text(crop.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1F2329')

            Text(crop.variety)
              .fontSize(14)
              .fontColor('#666666')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor('#F5F5F5')
              .borderRadius(4)
          }

          Text(crop.location)
            .fontSize(14)
            .fontColor('#8A8A8A')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Column({ space: 4 }) {
          Text(this.getStatusText(crop.status))
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getStatusColor(crop.status))
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)

          Text(`${crop.area}äº©`)
            .fontSize(12)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.End)
      }

      Row() {
        Column({ space: 4 }) {
          Text(`å½“å‰é˜¶æ®µï¼š${crop.currentStage}`)
            .fontSize(14)
            .fontColor('#1F2329')

          Progress({
            value: crop.progress,
            total: 100,
            type: ProgressType.Linear
          })
          .width('100%')
          .height(6)
          .backgroundColor('#F5F5F5')
          .color('#1890FF')

          Text(`è¿›åº¦ï¼š${crop.progress}%`)
            .fontSize(12)
            .fontColor('#666666')
        }
        .layoutWeight(1)
      }

      Row({ space: 12 }) {
        Text(`æ’­ç§ï¼š${crop.plantingDate}`)
          .fontSize(12)
          .fontColor('#666666')

        Text(`é¢„è®¡æ”¶è·ï¼š${crop.expectedHarvestDate}`)
          .fontSize(12)
          .fontColor('#666666')

        Text(`æ›´æ–°ï¼š${crop.lastUpdated}`)
          .fontSize(12)
          .fontColor('#8A8A8A')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }

      Row({ space: 8 }) {
        Button('æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            this.selectedCrop = crop;
          })

        Button('ç¼–è¾‘')
          .fontSize(12)
          .fontColor('#52C41A')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#52C41A' })
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            // ã€åŠŸèƒ½ç‚¹ã€‘ç¼–è¾‘ä½œç‰©ä¿¡æ¯
            // åº”æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†ï¼Œå…è®¸ä¿®æ”¹ä½œç‰©çš„å„é¡¹ä¿¡æ¯
            console.log(`ç¼–è¾‘ä½œç‰©: ${crop.name} (ID: ${crop.id})`);
            this.selectedCrop = crop;
            this.showAddDialog = true;
          })

        Button('è®°å½•')
          .fontSize(12)
          .fontColor('#FAAD14')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#FAAD14' })
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            // ã€åŠŸèƒ½ç‚¹ã€‘è®°å½•ä½œç‰©ç”Ÿé•¿ä¿¡æ¯
            // åº”æ‰“å¼€è®°å½•å¯¹è¯æ¡†ï¼Œè®°å½•æµ‡æ°´ã€æ–½è‚¥ã€ç—…è™«å®³ç­‰ä¿¡æ¯
            console.log(`è®°å½•ä½œç‰©ç”Ÿé•¿ä¿¡æ¯: ${crop.name} (ID: ${crop.id})`);
            this.selectedCrop = crop;
            // TODO: æ‰“å¼€ç”Ÿé•¿è®°å½•å¯¹è¯æ¡†
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  PlantingPlanTab() {
    Column({ space: 16 }) {
      Row() {
        Text('ç§æ¤è®¡åˆ’')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F2329')
          .layoutWeight(1)

        Button('+ æ–°å»ºè®¡åˆ’')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#52C41A')
          .borderRadius(8)
          .onClick(() => {
            this.showPlanDialog = true;
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16 })

      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.plantingPlans, (plan: PlantingPlan) => {
            this.PlanCard(plan)
          })

          if (this.plantingPlans.length === 0) {
            this.EmptyPlanState()
          }
        }
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .layoutWeight(1)
    }
    .layoutWeight(1)
  }

  @Builder
  PlanCard(plan: PlantingPlan) {
    Column({ space: 12 }) {
      Row() {
        Column({ space: 4 }) {
          Text(`${plan.cropName} - ${plan.variety}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1F2329')

          Text(`é¢ç§¯ï¼š${plan.area}äº©`)
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Text('è®¡åˆ’ä¸­')
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)
      }

      Row({ space: 16 }) {
        Text(`è®¡åˆ’æ’­ç§ï¼š${plan.plannedDate}`)
          .fontSize(14)
          .fontColor('#666666')

        Text(`é¢„è®¡æ”¶è·ï¼š${plan.expectedHarvest}`)
          .fontSize(14)
          .fontColor('#666666')
      }

      if (plan.notes) {
        Text(`å¤‡æ³¨ï¼š${plan.notes}`)
          .fontSize(14)
          .fontColor('#8A8A8A')
          .padding(8)
          .backgroundColor('#F8F9FA')
          .borderRadius(6)
      }

      Row({ space: 8 }) {
        Button('æ‰§è¡Œè®¡åˆ’')
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor('#52C41A')
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            // ã€åŠŸèƒ½ç‚¹ã€‘æ‰§è¡Œç§æ¤è®¡åˆ’
            // å°†è®¡åˆ’è½¬æ¢ä¸ºå®é™…ä½œç‰©è®°å½•å¹¶åˆ‡æ¢åˆ°ä½œç‰©ç›‘æ§æ ‡ç­¾
            this.executePlan(plan);
            this.currentTab = 0;
          })

        Button('ç¼–è¾‘')
          .fontSize(12)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            // ã€åŠŸèƒ½ç‚¹ã€‘ç¼–è¾‘ç§æ¤è®¡åˆ’
            // åº”æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†ï¼Œå…è®¸ä¿®æ”¹è®¡åˆ’ä¿¡æ¯
            console.log(`ç¼–è¾‘ç§æ¤è®¡åˆ’: ${plan.cropName} (ID: ${plan.id})`);
            this.showPlanDialog = true;
          })

        Button('åˆ é™¤')
          .fontSize(12)
          .fontColor('#FF4D4F')
          .backgroundColor('transparent')
          .border({ width: 1, color: '#FF4D4F' })
          .borderRadius(6)
          .layoutWeight(1)
          .onClick(() => {
            // ã€åŠŸèƒ½ç‚¹ã€‘åˆ é™¤ç§æ¤è®¡åˆ’
            console.log(`åˆ é™¤ç§æ¤è®¡åˆ’: ${plan.cropName} (ID: ${plan.id})`);
            this.deletePlan(plan.id);
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  EmptyState() {
    Column({ space: 12 }) {
      Text('ğŸŒ¾')
        .fontSize(48)

      Text('æš‚æ— ä½œç‰©æ•°æ®')
        .fontSize(16)
        .fontColor('#8A8A8A')

      Text('ç‚¹å‡»"æ·»åŠ ä½œç‰©"å¼€å§‹è®°å½•æ‚¨çš„ç§æ¤ä¿¡æ¯')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)

      Button('æ·»åŠ ç¬¬ä¸€ä¸ªä½œç‰©')
        .fontColor('#FFFFFF')
        .backgroundColor('#1890FF')
        .borderRadius(8)
        .onClick(() => {
          this.showAddDialog = true;
        })
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  EmptyPlanState() {
    Column({ space: 12 }) {
      Text('ğŸ“…')
        .fontSize(48)

      Text('æš‚æ— ç§æ¤è®¡åˆ’')
        .fontSize(16)
        .fontColor('#8A8A8A')

      Text('åˆ¶å®šæ‚¨çš„ç§æ¤è®¡åˆ’ï¼Œåˆç†å®‰æ’ä½œç‰©ç§æ¤æ—¶é—´')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)

      Button('åˆ›å»ºç§æ¤è®¡åˆ’')
        .fontColor('#FFFFFF')
        .backgroundColor('#52C41A')
        .borderRadius(8)
        .onClick(() => {
          this.showPlanDialog = true;
        })
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  PlanDialogOverlay() {
    Stack() {
      // åŠé€æ˜èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showPlanDialog = false;
          this.resetPlanForm();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // æ ‡é¢˜æ 
        Row() {
          Text('æ–°å»ºç§æ¤è®¡åˆ’')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1F2329')
            .layoutWeight(1)

          Text('âœ•')
            .fontSize(24)
            .fontColor('#666666')
            .onClick(() => {
              this.showPlanDialog = false;
              this.resetPlanForm();
            })
        }
        .width('100%')

        Scroll() {
          Column({ space: 16 }) {
            // ä½œç‰©ç±»å‹é€‰æ‹©
            Column({ space: 8 }) {
              Row() {
                Text('ä½œç‰©ç±»å‹')
                  .fontSize(14)
                  .fontColor('#333333')
                Text('*')
                  .fontSize(14)
                  .fontColor('#FF4D4F')
              }

              Row({ space: 8 }) {
                ForEach(this.cropTypes, (crop: CropType) => {
                  Button(crop.name)
                    .fontSize(14)
                    .fontColor(this.newPlanCropName === crop.name ? '#FFFFFF' : '#666666')
                    .backgroundColor(this.newPlanCropName === crop.name ? '#52C41A' : '#F5F5F5')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                    .onClick(() => {
                      this.newPlanCropName = crop.name;
                      this.newPlanVariety = ''; // é‡ç½®å“ç§é€‰æ‹©
                    })
                })
              }
            }
            .alignItems(HorizontalAlign.Start)

            // å“ç§é€‰æ‹©
            if (this.newPlanCropName) {
              Column({ space: 8 }) {
                Row() {
                  Text('å“ç§')
                    .fontSize(14)
                    .fontColor('#333333')
                  Text('*')
                    .fontSize(14)
                    .fontColor('#FF4D4F')
                }

                Row({ space: 8 }) {
                  ForEach(this.getCurrentVarieties(), (variety: string) => {
                    Button(variety)
                      .fontSize(14)
                      .fontColor(this.newPlanVariety === variety ? '#FFFFFF' : '#666666')
                      .backgroundColor(this.newPlanVariety === variety ? '#52C41A' : '#F5F5F5')
                      .borderRadius(8)
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .onClick(() => {
                        this.newPlanVariety = variety;
                      })
                  })
                }
              }
              .alignItems(HorizontalAlign.Start)
            }

            // ç§æ¤é¢ç§¯
            Column({ space: 8 }) {
              Row() {
                Text('ç§æ¤é¢ç§¯ï¼ˆäº©ï¼‰')
                  .fontSize(14)
                  .fontColor('#333333')
                Text('*')
                  .fontSize(14)
                  .fontColor('#FF4D4F')
              }

              TextInput({ placeholder: 'è¯·è¾“å…¥ç§æ¤é¢ç§¯', text: this.newPlanArea })
                .type(InputType.Number)
                .onChange((value: string) => {
                  this.newPlanArea = value;
                })
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)

            // è®¡åˆ’æ’­ç§æ—¥æœŸ
            Column({ space: 8 }) {
              Row() {
                Text('è®¡åˆ’æ’­ç§æ—¥æœŸ')
                  .fontSize(14)
                  .fontColor('#333333')
                Text('*')
                  .fontSize(14)
                  .fontColor('#FF4D4F')
              }

              TextInput({ placeholder: 'æ ¼å¼ï¼šYYYY-MM-DD', text: this.newPlanDate })
                .type(InputType.Normal)
                .onChange((value: string) => {
                  this.newPlanDate = value;
                })
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)

            // é¢„æœŸæ”¶è·æ—¥æœŸï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
            if (this.newPlanCropName && this.newPlanDate) {
              Column({ space: 8 }) {
                Text('é¢„æœŸæ”¶è·æ—¥æœŸ')
                  .fontSize(14)
                  .fontColor('#333333')

                Text(this.calculateHarvestDate(this.newPlanCropName, this.newPlanDate) || 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (YYYY-MM-DD)')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.calculateHarvestDate(this.newPlanCropName, this.newPlanDate) ? '#52C41A' : '#FF4D4F')
                  .padding(12)
                  .backgroundColor(this.calculateHarvestDate(this.newPlanCropName, this.newPlanDate) ? '#F0F9F0' : '#FFF1F0')
                  .borderRadius(8)
                  .width('100%')
              }
              .alignItems(HorizontalAlign.Start)
            }

            // å¤‡æ³¨
            Column({ space: 8 }) {
              Text('å¤‡æ³¨')
                .fontSize(14)
                .fontColor('#333333')

              TextArea({ placeholder: 'è¾“å…¥ç§æ¤è®¡åˆ’å¤‡æ³¨ä¿¡æ¯...', text: this.newPlanNotes })
                .height(80)
                .onChange((value: string) => {
                  this.newPlanNotes = value;
                })
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)
          }
          .padding({ left: 4, right: 4 })
        }
        .layoutWeight(1)

        // åº•éƒ¨æŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .layoutWeight(1)
            .onClick(() => {
              this.showPlanDialog = false;
              this.resetPlanForm();
            })

          Button('ç¡®è®¤æ·»åŠ ')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#52C41A')
            .borderRadius(8)
            .layoutWeight(1)
            .onClick(() => {
              this.addNewPlan();
            })
        }
      }
      .width('90%')
      .height('80%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: '#00000020',
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }
}