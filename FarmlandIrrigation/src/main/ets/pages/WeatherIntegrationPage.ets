// å½“å‰å¤©æ°”æ•°æ®æ¥å£
interface CurrentWeather {
  temperature: number;    // æ¸©åº¦
  humidity: number;       // æ¹¿åº¦
  pressure: number;       // æ°”å‹
  windSpeed: number;      // é£é€Ÿ
  windDirection: string;  // é£å‘
  visibility: number;     // èƒ½è§åº¦
  uvIndex: number;        // ç´«å¤–çº¿æŒ‡æ•°
  weatherDesc: string;    // å¤©æ°”æè¿°
  icon: string;           // å¤©æ°”å›¾æ ‡
}

// å¤©æ°”é¢„æŠ¥æ•°æ®æ¥å£
interface WeatherForecast {
  date: string;   // æ—¥æœŸ
  high: number;   // æœ€é«˜æ¸©åº¦
  low: number;    // æœ€ä½æ¸©åº¦
  desc: string;   // å¤©æ°”æè¿°
  icon: string;   // å¤©æ°”å›¾æ ‡
  rain: number;   // é™é›¨æ¦‚ç‡
}

// å¤©æ°”é¢„è­¦æ•°æ®æ¥å£
interface WeatherAlert {
  type: string;    // é¢„è­¦ç±»å‹
  title: string;   // é¢„è­¦æ ‡é¢˜
  content: string; // é¢„è­¦å†…å®¹
  level: string;   // é¢„è­¦ç­‰çº§
  time: string;    // é¢„è­¦æ—¶é—´
}

@Component
export default struct WeatherIntegrationPage {
  @State currentWeather: CurrentWeather = {
    temperature: 28.5,
    humidity: 72,
    pressure: 1013.2,
    windSpeed: 12.5,
    windDirection: 'ä¸œåŒ—é£',
    visibility: 15.6,
    uvIndex: 6,
    weatherDesc: 'å¤šäº‘',
    icon: 'â˜ï¸'
  };

  @State weatherForecast: WeatherForecast[] = [
    { date: 'ä»Šå¤©', high: 30, low: 22, desc: 'å¤šäº‘', icon: 'â˜ï¸', rain: 20 },
    { date: 'æ˜å¤©', high: 32, low: 24, desc: 'æ™´', icon: 'â˜€ï¸', rain: 5 },
    { date: 'åå¤©', high: 28, low: 20, desc: 'å°é›¨', icon: 'ğŸŒ§ï¸', rain: 80 },
    { date: 'å‘¨å››', high: 26, low: 18, desc: 'ä¸­é›¨', icon: 'ğŸŒ¦ï¸', rain: 90 },
    { date: 'å‘¨äº”', high: 29, low: 21, desc: 'é˜´', icon: 'â˜ï¸', rain: 30 }
  ];

  @State weatherAlerts: WeatherAlert[] = [
    { type: 'warning', title: 'å¤§é£é¢„è­¦', content: 'é¢„è®¡æ˜æ—¥é£é€Ÿå°†è¾¾åˆ°15m/sï¼Œè¯·æ³¨æ„é˜²æŠ¤', level: 'é»„è‰²', time: '2024-03-15 10:30' },
    { type: 'info', title: 'é™é›¨æé†’', content: 'åå¤©æœ‰ä¸­é›¨ï¼Œå»ºè®®æš‚åœçŒæº‰ä½œä¸š', level: 'è“è‰²', time: '2024-03-15 08:00' }
  ];

  @State lastUpdateTime: string = '2024-03-15 14:30:25';
  @State isRefreshing: boolean = false;

  aboutToAppear() {
    this.fetchWeatherData();
  }

  private async fetchWeatherData(): Promise<void> {
    try {
      this.isRefreshing = true;
      await new Promise<void>(resolve => setTimeout(resolve, 1000));
      
      this.currentWeather.temperature = 25 + Math.random() * 10;
      this.currentWeather.humidity = 60 + Math.random() * 30;
      this.lastUpdateTime = new Date().toLocaleString();
      
      console.log('ã€å¤©æ°”æ•°æ®ã€‘è·å–å¤©æ°”ä¿¡æ¯ï¼š', this.currentWeather);
    } catch (error) {
      console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isRefreshing = false;
    }
  }

  build() {
    Scroll() {
      Column({ space: 16 }) {
        // é¡µé¢æ ‡é¢˜å’Œåˆ·æ–°æŒ‰é’®
        Row() {
          Column() {
            Text('å¤©æ°”é›†æˆ')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1F2329')
            
            Text(`æ›´æ–°æ—¶é—´ï¼š${this.lastUpdateTime}`)
              .fontSize(12)
              .fontColor('#8A8A8A')
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Button() {
            Row({ space: 8 }) {
              if (this.isRefreshing) {
                LoadingProgress()
                  .width(16)
                  .height(16)
                  .color('#FFFFFF')
              }
              Text('åˆ·æ–°')
                .fontSize(14)
                .fontColor('#FFFFFF')
            }
          }
          .backgroundColor('#1890FF')
          .borderRadius(20)
          .height(36)
          .padding({ left: 16, right: 16 })
          .enabled(!this.isRefreshing)
          .onClick(() => {
            this.fetchWeatherData();
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16 })

        // å½“å‰å¤©æ°”å¡ç‰‡
        this.CurrentWeatherCard()

        // 5å¤©é¢„æŠ¥
        this.WeatherForecastSection()

        // æ°”è±¡æŒ‡æ•°
        this.WeatherIndexSection()

        // å¤©æ°”é¢„è­¦
        this.WeatherAlertsSection()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FAFAFA')
  }

  @Builder
  CurrentWeatherCard() {
    Column() {
      Row() {
        // å·¦ä¾§ä¸»è¦å¤©æ°”ä¿¡æ¯
        Column({ space: 8 }) {
          Row({ space: 12 }) {
            Text(this.currentWeather.icon)
              .fontSize(48)
            
            Column() {
              Text(`${this.currentWeather.temperature.toFixed(1)}Â°C`)
                .fontSize(36)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1F2329')
              
              Text(this.currentWeather.weatherDesc)
                .fontSize(16)
                .fontColor('#8A8A8A')
            }
            .alignItems(HorizontalAlign.Start)
          }
          
          Text('å½“å‰å¤©æ°”çŠ¶å†µ')
            .fontSize(14)
            .fontColor('#8A8A8A')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å³ä¾§è¯¦ç»†æ•°æ®
        Column({ space: 12 }) {
          this.WeatherDetailItem('æ¹¿åº¦', `${this.currentWeather.humidity}%`)
          this.WeatherDetailItem('æ°”å‹', `${this.currentWeather.pressure} hPa`)
          this.WeatherDetailItem('é£é€Ÿ', `${this.currentWeather.windSpeed} m/s`)
          this.WeatherDetailItem('èƒ½è§åº¦', `${this.currentWeather.visibility} km`)
        }
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 12,
      color: '#00000015',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  WeatherDetailItem(label: string, value: string) {
    Column({ space: 4 }) {
      Text(label)
        .fontSize(12)
        .fontColor('#8A8A8A')
      
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1F2329')
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  WeatherForecastSection() {
    Column({ space: 12 }) {
      Row() {
        Text('5å¤©é¢„æŠ¥')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F2329')
          .layoutWeight(1)
        
        Text('æŸ¥çœ‹è¯¦æƒ… >')
          .fontSize(14)
          .fontColor('#1890FF')
          .onClick(() => {
            console.log('æŸ¥çœ‹å¤©æ°”è¯¦æƒ…');
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      Scroll(new Scroller()) {
        Row({ space: 12 }) {
          ForEach(this.weatherForecast, (item: WeatherForecast, index: number) => {
            this.ForecastCard(item)
          })
        }
        .padding({ left: 16, right: 16 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }
  }

  @Builder
  ForecastCard(forecast: WeatherForecast) {
    Column({ space: 8 }) {
      Text(forecast.date)
        .fontSize(12)
        .fontColor('#8A8A8A')
      
      Text(forecast.icon)
        .fontSize(24)
      
      Text(forecast.desc)
        .fontSize(12)
        .fontColor('#1F2329')
        .textAlign(TextAlign.Center)
      
      Row({ space: 4 }) {
        Text(`${forecast.high}Â°`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1F2329')
        
        Text(`${forecast.low}Â°`)
          .fontSize(14)
          .fontColor('#8A8A8A')
      }
      
      Row({ space: 4 }) {
        Text('ğŸ’§')
          .fontSize(10)
        Text(`${forecast.rain}%`)
          .fontSize(12)
          .fontColor('#1890FF')
      }
    }
    .width(80)
    .height(120)
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  WeatherIndexSection() {
    Column({ space: 12 }) {
      Text('æ°”è±¡æŒ‡æ•°')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1F2329')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 16 })

      Grid() {
        GridItem() {
          this.IndexCard('ç´«å¤–çº¿', `${this.currentWeather.uvIndex}çº§`, 'å¼º', '#FF6B35')
        }
        GridItem() {
          this.IndexCard('ç©¿è¡£æŒ‡æ•°', 'èˆ’é€‚', 'å»ºè®®ç©¿è–„å¤–å¥—', '#52C41A')
        }
        GridItem() {
          this.IndexCard('è¿åŠ¨æŒ‡æ•°', 'é€‚å®œ', 'é€‚åˆæˆ·å¤–è¿åŠ¨', '#1890FF')
        }
        GridItem() {
          this.IndexCard('æ´—è½¦æŒ‡æ•°', 'ä¸å®œ', 'å¯èƒ½æœ‰é™é›¨', '#FAAD14')
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .height(200)
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  IndexCard(title: string, value: string, desc: string, color: string) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(14)
        .fontColor('#8A8A8A')
      
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      
      Text(desc)
        .fontSize(12)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  WeatherAlertsSection() {
    Column({ space: 12 }) {
      Text('å¤©æ°”é¢„è­¦')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1F2329')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 16 })

      if (this.weatherAlerts.length > 0) {
        ForEach(this.weatherAlerts, (alert: WeatherAlert, index: number) => {
          this.AlertCard(alert)
        })
      } else {
        this.EmptyAlertCard()
      }
    }
    .margin({ bottom: 20 })
  }

  @Builder
  AlertCard(alert: WeatherAlert) {
    Row({ space: 12 }) {
      Circle({ width: 8, height: 8 })
        .fill(alert.level === 'çº¢è‰²' ? '#FF4D4F' : 
              alert.level === 'é»„è‰²' ? '#FAAD14' : 
              alert.level === 'è“è‰²' ? '#1890FF' : '#52C41A')
      
      Column({ space: 4 }) {
        Row() {
          Text(alert.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1F2329')
            .layoutWeight(1)
          
          Text(alert.level)
            .fontSize(12)
            .fontColor('#FFFFFF')
            .padding({ top: 2, bottom: 2, left: 8, right: 8 })
            .backgroundColor(alert.level === 'çº¢è‰²' ? '#FF4D4F' : 
                            alert.level === 'é»„è‰²' ? '#FAAD14' : 
                            alert.level === 'è“è‰²' ? '#1890FF' : '#52C41A')
            .borderRadius(10)
        }
        .width('100%')
        
        Text(alert.content)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(alert.time)
          .fontSize(12)
          .fontColor('#8A8A8A')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  EmptyAlertCard() {
    Column({ space: 8 }) {
      Text('ğŸŒ¤ï¸')
        .fontSize(32)
      
      Text('æš‚æ— å¤©æ°”é¢„è­¦')
        .fontSize(16)
        .fontColor('#8A8A8A')
      
      Text('å½“å‰å¤©æ°”çŠ¶å†µè‰¯å¥½')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .height(120)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }
}